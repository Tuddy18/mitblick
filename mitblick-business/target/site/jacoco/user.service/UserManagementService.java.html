<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>UserManagementService.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">MitBlick Business</a> &gt; <a href="index.source.html" class="el_package">user.service</a> &gt; <span class="el_source">UserManagementService.java</span></div><h1>UserManagementService.java</h1><pre class="source lang-java linenums">package user.service;


import exception.BusinessException;
import exception.ExceptionCode;
import user.dao.UserPersistenceManager;
import user.dto.UserDTO;
import user.dto.UserDTOHelper;
import user.entities.Role;
import user.entities.User;
import utils.Encryptor;

import javax.ejb.EJB;
import javax.ejb.Stateless;
import java.util.List;
import java.util.Optional;
import java.util.regex.Matcher;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

@Stateless
<span class="nc" id="L22">public class UserManagementService {</span>
    public static final int MIN_USERNAME_LENGTH = 6;
    private static final int MIN_LAST_NAME_LENGTH = 5;
    private static final int MAX_FAILED_LOGN_ATTEMPTS = 5;


    @EJB
    private UserPersistenceManager userPersistenceManager;


    /**
     * Creates a user entity using a user DTO.
     *
     * @param userDTO user information
     * @return : the user DTO of the created entity
     * @throws BusinessException
     */
    public UserDTO createUser(UserDTO userDTO) throws BusinessException {
<span class="nc" id="L40">        validateUserForCreation(userDTO);</span>
<span class="nc" id="L41">        User user = UserDTOHelper.toEntity(userDTO);</span>
<span class="nc" id="L42">        user.setActive(true);</span>
<span class="nc" id="L43">        user.setPassword(Encryptor.encrypt(userDTO.getPassword()));</span>
<span class="nc" id="L44">        userPersistenceManager.createUser(user);</span>
<span class="nc" id="L45">        return UserDTOHelper.fromEntity(user);</span>
    }


    /**
     * Validates the DTO. To use before sending it further.
     *
     * @param userDTO
     * @throws BusinessException
     */
    private void validateUserForCreation(UserDTO userDTO) throws BusinessException {
<span class="nc bnc" id="L56" title="All 2 branches missed.">        if (!isValidForCreation(userDTO)) {</span>
<span class="nc" id="L57">            throw new BusinessException(ExceptionCode.USER_VALIDATION_EXCEPTION);</span>
        }


<span class="nc" id="L61">    }</span>

    private boolean validateFields(UserDTO userDTO) {
<span class="nc" id="L64">        return</span>
<span class="nc bnc" id="L65" title="All 2 branches missed.">                userDTO.getEmail() != null</span>
<span class="nc bnc" id="L66" title="All 2 branches missed.">                        &amp;&amp; isValidEmail(userDTO.getEmail());</span>
    }

    private boolean isValidForCreation(UserDTO userDTO) throws BusinessException {
        //validate if email already exists
<span class="nc bnc" id="L71" title="All 2 branches missed.">        if (userPersistenceManager.getUserByEmail(userDTO.getEmail()).isPresent()) {</span>
<span class="nc" id="L72">            throw new BusinessException(ExceptionCode.EMAIL_EXISTS_ALREADY);</span>
        }
<span class="nc bnc" id="L74" title="All 2 branches missed.">        return validateFields(userDTO)</span>
<span class="nc bnc" id="L75" title="All 2 branches missed.">                &amp;&amp; userDTO.getPassword() != null;</span>
    }

    private boolean isValidEmail(String email) {
<span class="nc" id="L79">        final Pattern validEmailAddressRegex =</span>
<span class="nc" id="L80">                Pattern.compile(&quot;^[a-zA-Z][A-Za-z0-9._]*@[a-zA-z]+.[a-z]+$&quot;, Pattern.CASE_INSENSITIVE);</span>
<span class="nc" id="L81">        Matcher matcher = validEmailAddressRegex.matcher(email);</span>
<span class="nc" id="L82">        return matcher.find();</span>
    }

    public List&lt;User&gt; getAllUsersWithRole(Role role) {
<span class="nc" id="L86">        return userPersistenceManager.getAllUsers()</span>
<span class="nc" id="L87">                .stream()</span>
<span class="nc" id="L88">                .filter(user -&gt; user.getRoles().contains(role))</span>
<span class="nc" id="L89">                .collect(Collectors.toList());</span>
    }

    /**
     * Deactivates a user, removing them the ability to login, but keeping their bugs, comments, etc.
     * Additionally creates the specific notification.
     *
     * @param email
     */
    public void deactivateUser(String email) throws BusinessException {

<span class="nc" id="L100">        Optional&lt;User&gt; userOptional = userPersistenceManager.getUserByEmail(email);</span>
<span class="nc" id="L101">        User user = userOptional.orElseThrow(() -&gt; new BusinessException(ExceptionCode.EMAIL_NOT_FOUND));</span>
<span class="nc" id="L102">        user.setActive(false);</span>
<span class="nc" id="L103">        userPersistenceManager.updateUser(user);</span>

<span class="nc" id="L105">    }</span>


    /**
     * Activates a user, granting them the ability to login.
     *
     * @param email
     */
    public void activateUser(String email) throws BusinessException {
<span class="nc" id="L114">        Optional&lt;User&gt; userOptional = userPersistenceManager.getUserByEmail(email);</span>
<span class="nc" id="L115">        User user = userOptional.orElseThrow(() -&gt; new BusinessException(ExceptionCode.EMAIL_NOT_FOUND));</span>
<span class="nc" id="L116">        user.setActive(true);</span>
<span class="nc" id="L117">        userPersistenceManager.updateUser(user);</span>

<span class="nc" id="L119">    }</span>

    /**
     * Get a list of all Users that are registered.
     *
     * @return
     */
    public List&lt;UserDTO&gt; getAllUsers() {
<span class="nc" id="L127">        return userPersistenceManager.getAllUsers()</span>
<span class="nc" id="L128">                .stream()</span>
<span class="nc" id="L129">                .map(UserDTOHelper::fromEntity)</span>
<span class="nc" id="L130">                .collect(Collectors.toList());</span>
    }


    /**
     * Takes the username and password of a user and if they are correct, it returns the
     * corresponding DTO. Otherwise it will throw an exception.
     * If there were more than 5 failed login attempts for the user, it will deactivate the user.
     *
     * @param email
     * @param password
     * @return a user DTO if it succeeds.
     * @throws BusinessException
     */
    public UserDTO login(String email, String password) throws BusinessException {
<span class="nc" id="L145">        Optional&lt;User&gt; userOptional = userPersistenceManager.getUserByEmail(email);</span>
<span class="nc bnc" id="L146" title="All 2 branches missed.">        if (!userOptional.isPresent()) {</span>
<span class="nc" id="L147">            throw new BusinessException(ExceptionCode.EMAIL_NOT_FOUND);</span>
        }
<span class="nc bnc" id="L149" title="All 2 branches missed.">        if (!Encryptor.encrypt(password).equals(userOptional.get().getPassword())) {</span>
<span class="nc" id="L150">            User user = userOptional.get();</span>
<span class="nc bnc" id="L151" title="All 2 branches missed.">            int failedAttempts = user.getFailedAttempts() == null ? 1 : user.getFailedAttempts() + 1;</span>
<span class="nc" id="L152">            user.setFailedAttempts(failedAttempts);</span>
<span class="nc bnc" id="L153" title="All 2 branches missed.">            if (userOptional.get().getFailedAttempts() &gt; MAX_FAILED_LOGN_ATTEMPTS) {</span>
<span class="nc" id="L154">                deactivateUser(email);</span>
            }
<span class="nc" id="L156">            throw new BusinessException(ExceptionCode.PASSWORD_NOT_VALID);</span>
        }
<span class="nc bnc" id="L158" title="All 2 branches missed.">        if (!userOptional.get().getActive()) {</span>
<span class="nc" id="L159">            throw new BusinessException(ExceptionCode.USER_DEACTIVATED);</span>
        }

<span class="nc" id="L162">        User user = userOptional.get();</span>
<span class="nc" id="L163">        user.setFailedAttempts(0);</span>
<span class="nc" id="L164">        return UserDTOHelper.fromEntity(userOptional.get());</span>
    }




    /**
     * Returns the user entity with the given username.
     *
     * @param email
     * @return
     * @throws BusinessException
     */
    public User getUserForEmail(String email) throws BusinessException {
<span class="nc" id="L178">        return userPersistenceManager</span>
<span class="nc" id="L179">                .getUserByEmail(email)</span>
<span class="nc" id="L180">                .orElseThrow(() -&gt; new BusinessException(ExceptionCode.EMAIL_NOT_FOUND));</span>
    }

    /**
     * Returns the user with the given ID.
     *
     * @param id
     * @return
     * @throws BusinessException
     */
    public User getUserForId(Long id) throws BusinessException {
<span class="nc" id="L191">        Optional&lt;User&gt; userOptional = userPersistenceManager.getUserById(id);</span>
<span class="nc bnc" id="L192" title="All 2 branches missed.">        if (userOptional.isPresent()) {</span>
<span class="nc" id="L193">            return userOptional.get();</span>
        } else {
<span class="nc" id="L195">            throw new BusinessException(ExceptionCode.EMAIL_NOT_FOUND);</span>
        }
    }

    /**
     * Updates the user with the contents of the given DTO. If the name of the user has changed it will also
     * change the username.
     * Also creates the notification message and type to be sent to both users.
     *
     * @param userDTO
     * @return
     * @throws BusinessException
     */
    public UserDTO updateUser(UserDTO userDTO) throws BusinessException {

<span class="nc" id="L210">        Optional&lt;User&gt; userBeforeOptional = userPersistenceManager.getUserByEmail(userDTO.getEmail());</span>

<span class="nc bnc" id="L212" title="All 2 branches missed.">        if (userBeforeOptional.isPresent()) {</span>
<span class="nc" id="L213">            User userBefore = userBeforeOptional.get();</span>
<span class="nc" id="L214">            validateUserForUpdate(userDTO);</span>
<span class="nc" id="L215">            User userAfter = UserDTOHelper.updateEntityWithDTO(userBefore, userDTO);</span>

<span class="nc" id="L217">            userPersistenceManager.updateUser(userAfter);</span>

<span class="nc" id="L219">            return userDTO;</span>
        } else {
<span class="nc" id="L221">            throw new BusinessException(ExceptionCode.EMAIL_NOT_FOUND);</span>
        }
    }


    private void validateUserForUpdate(UserDTO userDTO) throws BusinessException {
<span class="nc bnc" id="L227" title="All 2 branches missed.">        if (!validateFields(userDTO)) {</span>
<span class="nc" id="L228">            throw new BusinessException(ExceptionCode.USER_VALIDATION_EXCEPTION);</span>
        }
<span class="nc" id="L230">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.7.9.201702052155</span></div></body></html>